format_version: 10

pipelines:
  test-pipeline:
    group: "test-group"
    label_template: "${COUNT}"
    materials:
      app-repo:
        type: git
        url: "https://github.com/Pansaar/app-gpt-embeded.git"
        branch: "main"
    
    stages:
      - Build:
          fetch_materials: true 
          jobs:
            BuildJob:
              clean_workspace: true 
              resources:
                - BuildJob
              tasks:
                - exec:
                    command: bash
                    arguments:
                      - "-c"
                      - |
                        if [ ! -d "vite-frontend" ]; then echo "vite-frontend directory not found!"; exit 1; fi
                        cd vite-frontend
                        npm install
                        npm run build

      - Deploy:
          fetch_materials: true
          jobs:
            DeployJob:
              resources:
                - BuildJob  # ✅ Ensures it runs on the same agent
                - DeployJob
              tasks:
                - exec:
                    command: bash
                    arguments:
                      - "-c"
                      - |
                        if ! command -v aws &> /dev/null; then echo "AWS CLI not found!"; exit 1; fi
                        aws s3 cp vite-frontend/dist/index.html s3://bay-auto-chatbot-frontend/index.html

                - exec:
                    command: bash
                    arguments:
                      - "-c"
                      - |
                        aws s3 sync vite-frontend/dist/assets/ s3://bay-auto-chatbot-frontend/assets/ --delete

                # Uncomment the following if you want to deploy to Azure Web App
                # - exec:
                #     command: bash
                #     arguments:
                #       - "-c"
                #       - |
                #         az webapp config appsettings set --resource-group test-resource-group --name test-web-app-pansaar --settings WEBSITE_NODE_DEFAULT_VERSION=20 SCM_DO_BUILD_DURING_DEPLOYMENT=false WEBSITES_ENABLE_APP_SERVICE_STORAGE=false
                
                # - exec:
                #     command: bash
                #     arguments:
                #       - "-c"
                #       - |
                #         cd vite-frontend/dist
                #         zip -r ../dist.zip .  # Ensure only contents inside `dist/` are zipped
                #         cd ..
                #         az webapp deploy --resource-group test-resource-group --name test-web-app-pansaar --src-path dist.zip --type zip
                
                # - exec:
                #     command: bash
                #     arguments:
                #       - "-c"
                #       - |
                #         az webapp restart --name test-web-app-pansaar --resource-group test-resource-group

environments:
  test-env:
    pipelines:
      - test-pipeline
    agents:
      - bc4933d0-8d6a-4f5e-b37f-15945aacde3f  # ✅ Same agent for BuildJob & DeployJob
